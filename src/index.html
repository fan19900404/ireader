<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>一键下载小说</title>
</head>

<body>
  <script>
    if (typeof Promise === 'undefined') {
      document.write('<div>抱歉不支持你的浏览器，请升级</div>');
    } else {
      window.onload = function () {
        var $root = document.getElementById('root');
        $root.style = "display:block";
      }
    }
  </script>
  <noscript>本网页需要运行javascript</noscript>
  <div id="root" style="display:none">
    <div>粘贴网址：</div>
    <div>
      <input type="text" id='url'>
    </div>
    <div id="send">确认</div>
    <div id="msg"></div>
  </div>
  <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdn.bootcss.com/IndexedDBShim/3.1.0/indexeddbshim.min.js"></script>
  <script>
    $(function () {
      var DB_NAME = 'library'; // 图书馆
      // var DB_VERSTON = 1; // 不知道版本要来干什么
      var DB_STORE_NAME = 'books'; // 小说
      var version;

      var db;

      function initDb() { // 数据库初始化
        console.debug("initDb ...");
        var req = indexedDB.open(DB_NAME);
        req.onsuccess = function (evt) {
          // Better use "this" than "req" to get the result to avoid problems with
          // garbage collection.
          // db = req.result;
          db = this.result;
          version = db.version;
          console.debug("initDb DONE");
        };
        req.onerror = function (evt) {
          console.error("initDb:", evt.target.errorCode);
        };

        req.onupgradeneeded = function (evt) {
          console.debug("initDb.onupgradeneeded");
          var store = evt.currentTarget.result.createObjectStore(
            DB_STORE_NAME, {
              keyPath: 'id',
              autoIncrement: true
            });
          store.createIndex('url', 'url', {
            unique: true
          });
          store.createIndex('author', 'author', {
            unique: false
          });
          store.createIndex('title', 'title', {
            unique: false
          });
        };
      }

      // function getBook(bookID){
      //   var objectStore = db.transaction([DB_STORE_NAME]).objectStore(DB_STORE_NAME);
      //     var request = objectStore.get(bookID);
      //     request.onerror = function (event) {
      //       // 错误处理!
      //     };
      //     request.onsuccess = function (event) {
      //       var data = request.result.catalog || [];
      //       addChapter(data.map(function(v){

      //       }))
      //     };
      // }

      function createChapterStore(bookID) { // 创建书目章节数据对象（表）
        console.debug("ChapterStore ...");
        var req = indexedDB.open(DB_NAME, version + 1);
        req.onsuccess = function (evt) {
          // Better use "this" than "req" to get the result to avoid problems with
          // garbage collection.
          // db = req.result;
          db = this.result;
          console.debug("ChapterStore DONE", db.version);
          // getBook(bookID);
          downChapter(bookID);
        };
        req.onerror = function (evt) {
          console.error("ChapterStore:", evt.target.errorCode);
        };

        req.onupgradeneeded = function (evt) {
          console.debug("ChapterStore.onupgradeneeded");
          var store = evt.currentTarget.result.createObjectStore(
            "chapter" + bookID, {
              keyPath: 'id',
              autoIncrement: true
            });
          store.createIndex('url', 'url', {
            unique: true
          });
          store.createIndex('chapter', 'chapter', {
            unique: false
          });
        };
      }

      function addBook(data) { // 新增一本书
        var bookID;
        var transaction = db.transaction([DB_STORE_NAME], "readwrite");
        // 当所有的数据都被增加到数据库时执行一些操作
        transaction.oncomplete = function (event) {
          console.log("All done!");
          db.close();
          createChapterStore(bookID);
        };

        transaction.onerror = function (event) {
          // 不要忘记进行错误处理！
        };

        var objectStore = transaction.objectStore(DB_STORE_NAME);

        var request = objectStore.put(data);
        request.onsuccess = function (event) {
          console.log(event);
          bookID = event.target.result;
        };
        request.onerror = function (event) {
          console.log(event);
        }

      }

      function addChapter(data){

      }


      $('#send').on('click', function () {
        var inputVal = $('#url').val();
        if (inputVal == '') {
          $('#msg').html('请输入正确的网址');
          return false;
        }
        $.ajax({
          url: '/api/catalog',
          method: 'get',
          dataType: 'JSON',
          data: {
            url: inputVal
          },
          success: function (data) {
            console.log(data);
            addBook({
              url: inputVal,
              title: data.book,
              author: data.author,
              catalog: data.catalog.map(function (val, index) {
                return {
                  url: val.url,
                  chapter: val.title,
                  contentId: null
                }
              })
            })
          },
          error: function (error, data) {
            alert(data);
          }
        })
      })

      initDb();
    })
  </script>
</body>

</html>